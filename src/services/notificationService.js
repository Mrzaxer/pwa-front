import { apiService } from './api.js';

class NotificationService {
  constructor() {
    this.publicVapidKey = 'BNp1ar-IkRx3TxfzMcRU26UTyd9J5gVDBlsgdIotdBXI3WvpBOhBT6taVXyZURzeDIe0aTb7Ly9251wu8EFVTYI';
  }

  // Verificar compatibilidad
  isSupported() {
    return 'Notification' in window && 
           'serviceWorker' in navigator && 
           'PushManager' in window;
  }

  // Solicitar permiso para notificaciones
  async requestPermission() {
    if (!this.isSupported()) {
      console.log('‚ùå Este navegador no soporta notificaciones push');
      return false;
    }

    if (Notification.permission === 'granted') {
      console.log('‚úÖ Permiso para notificaciones ya concedido');
      return true;
    }

    if (Notification.permission === 'denied') {
      console.log('‚ùå Permiso para notificaciones denegado');
      return false;
    }

    try {
      const permission = await Notification.requestPermission();
      
      if (permission === 'granted') {
        console.log('‚úÖ Permiso para notificaciones concedido');
        return true;
      } else {
        console.log('‚ùå Permiso para notificaciones denegado');
        return false;
      }
    } catch (error) {
      console.error('‚ùå Error solicitando permiso:', error);
      return false;
    }
  }

  // Suscribirse a notificaciones push
  async subscribeToPush() {
    if (!this.isSupported()) {
      console.log('‚ùå Notificaciones push no soportadas');
      return null;
    }

    try {
      const registration = await navigator.serviceWorker.ready;
      let subscription = await registration.pushManager.getSubscription();

      // Si ya est√° suscrito, usar esa suscripci√≥n
      if (subscription) {
        console.log('üì± Usuario ya suscrito a notificaciones push');
        return subscription;
      }

      // Crear nueva suscripci√≥n
      subscription = await registration.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: this.urlBase64ToUint8Array(this.publicVapidKey)
      });

      console.log('üì± Nueva suscripci√≥n push creada');

      // Enviar suscripci√≥n al servidor
      await apiService.subscribeToPush(subscription);

      return subscription;
    } catch (error) {
      if (Notification.permission === 'denied') {
        console.log('‚ùå Permiso para notificaciones denegado por el usuario');
      } else {
        console.error('‚ùå Error suscribiendo a push:', error);
      }
      return null;
    }
  }

  // Convertir clave p√∫blica a Uint8Array
  urlBase64ToUint8Array(base64String) {
    try {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding)
        .replace(/-/g, '+')
        .replace(/_/g, '/');

      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);

      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    } catch (error) {
      console.error('‚ùå Error convirtiendo VAPID key:', error);
      throw new Error('Clave VAPID inv√°lida');
    }
  }

  // Enviar notificaci√≥n de prueba
  async sendTestNotification() {
    try {
      const result = await apiService.sendNotification(
        '¬°Hola desde Mi PWA! üëã',
        'Esta es una notificaci√≥n push de prueba desde el frontend',
        '/icons/icon-192x192.png',
        '/'
      );
      
      console.log('üì§ Notificaci√≥n enviada:', result);
      return result;
    } catch (error) {
      console.error('‚ùå Error enviando notificaci√≥n:', error);
      throw error;
    }
  }

  // Verificar si el usuario est√° suscrito
  async isSubscribed() {
    if (!this.isSupported()) return false;

    try {
      const registration = await navigator.serviceWorker.ready;
      const subscription = await registration.pushManager.getSubscription();
      return subscription !== null;
    } catch (error) {
      console.error('‚ùå Error verificando suscripci√≥n:', error);
      return false;
    }
  }

  // Desuscribirse
  async unsubscribe() {
    if (!this.isSupported()) return false;

    try {
      const registration = await navigator.serviceWorker.ready;
      const subscription = await registration.pushManager.getSubscription();

      if (subscription) {
        await subscription.unsubscribe();
        console.log('üì± Usuario desuscrito de notificaciones push');
        return true;
      }
      return false;
    } catch (error) {
      console.error('‚ùå Error desuscribiendo:', error);
      return false;
    }
  }

  // Obtener estado completo de notificaciones
  async getNotificationStatus() {
    const supported = this.isSupported();
    const permission = Notification.permission;
    const subscribed = supported ? await this.isSubscribed() : false;
    
    return {
      supported,
      permission,
      subscribed,
      vapidKey: this.publicVapidKey ? '‚úÖ Configurada' : '‚ùå No configurada'
    };
  }

  // Enviar notificaci√≥n personalizada
  async sendCustomNotification(title, options = {}) {
    return await apiService.sendNotification(
      title,
      options.body || '',
      options.icon || '/icons/icon-192x192.png',
      options.url || '/'
    );
  }
}

export const notificationService = new NotificationService();